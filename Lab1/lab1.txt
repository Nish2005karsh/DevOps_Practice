Managing Deployment using Kubernetes engine
Kubernetes is used to manage the docker containers

Overview:
Dev Ops practices will regularly make use of multiple deployments to manage application deployment scenarios such as "Continuous deployment", "Blue-Green deployments", "Canary deployments" and more. This lab teaches you how to scale and manage containers so you can accomplish these common scenarios where multiple heterogeneous deployments are being used.

In this lab , i:
Use the kubectl tool
Create deployment yaml files
Launch, update, and scale deployments

Initial Setup
1.Set the zone
commd->gcloud config set compute/zone us-east-4-b.
gcloud->google cloud

2.Get the sample code
commd->gcloud storage cp -r gs://spls/gsp053/kubernetes.
cd kubernetes

3.Create a cluster(takes a feew minutes)
gcloud container clusters create bootcamp\--machine-type e2-small \--num-nodes 3
\--scopes "https://www.googleapis.com/auth/projecthosting,storage-rw"

Step2:Create deployment

# View the deployment configuration
1.cat deployment/fortune-app-blue.yaml
#Create deployment

kubectl create -f deployments/fortune-app-blue.yaml

#Verify deployments
kubectl get deployments

#Verify replicaset
kubectl get replicasets

#verify  the pods
kubectl get pods

#Create services
kubectl create -f services/fortune-app.yaml

#Get service external IP
kubectl get services fortune-app

#test the service
curl http://`kubectl get svc fortune-app -o =jsonpath="{status.loadBalancer.ingres[0].ip}"`\version

3.Scaling deployment
#Scale upto 5 replicas

kubectl scale deployment fortune-app-blue --replicas=5

#Verify count(should show  5)
kubectl get pods | grep fortune-app-blue | wc -1

#Scae back to three(3) replicas
kubectl scale deployment fortune-app-blue --replicas=3

#Verify count(should show 3)
kubectl get pods | grep fortune-blue-app |  wc -1

4.Rolling updates
# Edit the deployment (interactive step)
kubectl edit deployment fortune-app-blue

Inside the editor 
Press i to inser teh nodes
Find the image line and change app verison from 1.0.0 to 2.0.0
press escape and then do :wq to close the editor

#Check replicaset
kubectl get replicaset

#Check rollout history '
kubectl rollout history  deployment/fortune-app-Blue

#Pause the rollout
kubectl rollout pause deployment/fortune-app-blue

#Check rollout status
kubectl rollout status deployment/fortune-app-blue

#Check version across pods
for p  in $(kubectl get pods -1 app=fortune-app -o=jsonpath='{.items[*].metadata.name}');
do echo  $p && curl -s http://$(kubectl get pod  $p -o=jsonpath='{.status.podIP})/version;echo;done

#Resume the rollout
kubectl rollout resume deployment/fortune-blue-app

#Check status again
kubectl rollout status deployment/fortune-blue-app

#Verify roll back
curl http://`kubectl get svc fortune-app -o=jsonpath="{.status.loadBalancer.ingress[0].ip}"`/version

5.Canary deployment

#View canary configuration
cat deployment/fortune-app-canary.yaml

#Create canary deployment
kubectl create -f deployments/fortune-app-canary.yaml

#Verify both deployments exist
kubectl get deployments

# Test canary (run multiple times to see traffic distribution)
for i in {1..10}; do curl -s http://`kubectl get svc fortune-app -o=jsonpath="{.status.loadBalancer.ingress[0].ip}"`/version; echo; done

6.Blue green deployment

#Update service  to point to blue only
kubectl apply -f services/fortune-app-blue-service.yaml

# Create green deployment
kubectl create -f  deployments/fortune-app-green-service.yaml

# Verify still serving v1.0.0
curl http://`kubectl get svc fortune-app -o=jsonpath="{.status.loadBalancer.ingress[0].ip}"`/version

#Switch service to green
kubectl apply -f services/fortune-app-green-service.yaml

# Verify now serving v2.0.0
curl http://`kubectl get svc fortune-app -o=jsonpath="{.status.loadBalancer.ingress[0].ip}"`/version

#Roll back to Blue
kubectl apply -f services/fortune-app-blue-service.yaml

# Verify rollback to v1.0.0
curl http://`kubectl get svc fortune-app -o=jsonpath="{.status.loadBalancer.ingress[0].ip}"`/version


Important commands

->check the cluster exists
gcloud containers cluster list

->Clean up
gcloud container clusters delete bootcamp  --zone=us-east4-b --quiet

->Recreate teh cluster
gcloud container clusters create cluster_name(bootcamp)\
--machine-type e2-small\
--num-nod=3\
--scopes  "https://www.googleapis.com/auth/projecthosting,storage-rw"

->Veriy if the cluster is ready 
gcloud cluster container list

->Continue with the tab

kubectl explain deployment

